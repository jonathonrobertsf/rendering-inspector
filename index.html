<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rendering Inspector – SSR / CSR Detector</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .fade-in { animation: fadein 0.4s ease; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Navbar -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-800">Rendering Inspector</h1>
      <nav class="hidden md:flex gap-6 text-gray-600 font-medium">
        <a href="#" class="hover:text-gray-900">Home</a>
        <a href="#" class="hover:text-gray-900">Docs</a>
        <a href="#" class="hover:text-gray-900">About</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow">
    <div class="max-w-6xl mx-auto px-6 py-10">

      <!-- Intro -->
      <div class="mb-10">
        <h2 class="text-4xl font-bold text-gray-900 mb-4">SSR / CSR Detection Tool</h2>
        <p class="text-gray-600 text-lg max-w-3xl">
          Enter a website URL and this tool will compare the raw HTML against the rendered version to guess whether it's
          <span class="font-semibold">SSR/SSG</span> or <span class="font-semibold">CSR</span>.
        </p>
      </div>

      <!-- Input Card -->
      <div class="bg-white shadow rounded-xl p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-center">
          <input 
            id="urlInput"
            class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            placeholder="https://example.com"
            type="text"
          />
          <button
            onclick="runCheck()"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition"
          >
            Analyse
          </button>
        </div>
      </div>

      <!-- Results + Preview Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Result Card -->
        <div id="result" class="bg-white shadow rounded-xl p-6 fade-in hidden"></div>

        <!-- Preview Card -->
        <div class="bg-white shadow rounded-xl p-6">
          <h3 class="text-xl font-semibold mb-3">Rendered Preview</h3>
          <iframe
            id="preview"
            class="w-full h-[520px] border rounded-lg"
            src="https://placehold.co/1000x520?text=Website+Preview"
            loading="lazy"
          ></iframe>
        </div>

      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-10">
    <div class="max-w-6xl mx-auto px-6 py-6 text-center text-gray-600">
      Rendering Inspector © 2025. Crafted for analysing modern web rendering behaviour.
    </div>
  </footer>

  <!-- Script -->
<script>
async function runCheck() {
    const urlInput = document.getElementById("urlInput").value.trim();
    const resultBox = document.getElementById("resultBox");
    const rawColumn = document.getElementById("rawHTML");
    const renderedColumn = document.getElementById("renderedHTML");
    const iframe = document.getElementById("renderFrame");

    if (!urlInput) {
        resultBox.innerHTML = `<p class="text-red-600 font-bold">Please enter a URL.</p>`;
        return;
    }

    // Reset UI
    rawColumn.textContent = "Fetching raw HTML...";
    renderedColumn.textContent = "Loading iframe...";
    resultBox.innerHTML = `<p class="text-blue-600 font-bold">Analysing…</p>`;

    // --- FETCH RAW HTML FROM API ---
    let rawHtml = "";
    try {
        const apiUrl = `/api/fetch-html.js?url=${encodeURIComponent(urlInput)}`;
        const response = await fetch(apiUrl);

        if (!response.ok) throw new Error("API returned " + response.status);

        const data = await response.json();
        rawHtml = data.html || "";

        console.log("RAW LENGTH:", rawHtml.length);

        if (!rawHtml || rawHtml.length < 50) {
            rawColumn.textContent = "Error: Raw HTML is empty or blocked by the website.";
            resultBox.innerHTML = `
                <p class="text-red-600 font-bold">The website blocked server-side HTML fetching.</p>
                <p class="text-gray-700">Some sites (Next.js + Cloudflare) won't allow raw HTML extraction.</p>
            `;
            return;
        }

        rawColumn.textContent = rawHtml;

    } catch (err) {
        console.error(err);
        rawColumn.textContent = "Error fetching raw HTML.";
        resultBox.innerHTML = `
            <p class="text-red-600 font-bold">Error fetching raw HTML</p>
            <p class="text-gray-700">${err.message}</p>
        `;
        return;
    }

    // --- LOAD IFRAME ---
    iframe.src = urlInput;

    // Give the iframe time to hydrate
    await new Promise(resolve => setTimeout(resolve, 1500));

    // POLL THE IFRAME DOM SAFELY
    function tryGetRenderedHTML() {
        try {
            return iframe.contentDocument.documentElement.innerHTML;
        } catch (e) {
            return "";
        }
    }

    let renderedHtml = "";
    let attempts = 0;

    while (attempts < 20) {
        renderedHtml = tryGetRenderedHTML();

        if (renderedHtml && renderedHtml.length > 50) break;

        attempts++;
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    if (!renderedHtml || renderedHtml.length < 50) {
        renderedColumn.textContent = "Could not extract fully rendered HTML (iframes may be blocked).";
        resultBox.innerHTML = `
            <p class="text-red-600 font-bold">Iframe HTML not accessible.</p>
            <p class="text-gray-700">Some websites block iframe access using COOP/COEP or Cloudflare.</p>
        `;
        return;
    }

    renderedColumn.textContent = renderedHtml;

    // --- DETERMINE SSR / CSR ---

    // Heuristic based on real-world Next.js behaviour
    const isCSR =
        rawHtml.includes("BAILOUT_TO_CLIENT_SIDE_RENDERING") ||
        rawHtml.includes("__next_f.push") ||
        !rawHtml.replace(/\s+/g, "").match(/<main|<div|<section/); // no real content

    if (isCSR) {
        resultBox.innerHTML = `
            <p class="text-yellow-700 font-bold text-xl">Client-Side Rendering (CSR)</p>
            <p class="text-gray-700 mt-2">The server delivered almost no usable HTML. The page is rendered in the browser via JavaScript.</p>
        `;
    } else {
        resultBox.innerHTML = `
            <p class="text-green-700 font-bold text-xl">Server-Side Rendering (SSR)</p>
            <p class="text-gray-700 mt-2">Meaningful HTML was delivered directly from the server.</p>
        `;
    }
}
</script>


</body>
</html>
