<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rendering Inspector</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-6xl mx-auto py-10">

        <h1 class="text-3xl font-bold text-center mb-6">Rendering Inspector</h1>

        <!-- INPUT AREA -->
        <div class="flex gap-4 mb-6">
            <input id="urlInput"
                   type="text"
                   placeholder="Enter a URL (e.g. https://flirtist.ai)"
                   class="flex-1 px-4 py-2 border rounded w-full">
            <button id="checkBtn"
                    class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Analyse
            </button>
        </div>

        <!-- RESULT BOX -->
        <div id="resultBox" class="mb-6 text-center text-lg font-semibold text-gray-700">
            Waiting for input…
        </div>

        <!-- TWO COLUMN LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- LEFT COLUMN: RAW HTML -->
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-2">Raw HTML Returned by Server</h2>
                <pre id="rawHTML"
                     class="whitespace-pre-wrap text-sm bg-gray-100 p-3 rounded max-h-[70vh] overflow-auto">
                </pre>
            </div>

            <!-- RIGHT COLUMN: LIVE PREVIEW -->
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-2">Browser Rendering (Iframe Preview)</h2>
                <iframe id="renderFrame"
                        class="w-full h-[70vh] border rounded bg-white"
                        src="https://placehold.co/600x400?text=Preview+Here">
                </iframe>
            </div>

        </div>
    </div>

    <!-- ============================= -->
    <!--   SSR / CSR DETECTOR LOGIC    -->
    <!-- ============================= -->

    <script>
    // --- MAIN ANALYSER FUNCTION ---
    async function runCheck() {
        console.log("runCheck() started");

        const urlInput = document.getElementById("urlInput").value.trim();
        const resultBox = document.getElementById("resultBox");
        const rawColumn = document.getElementById("rawHTML");
        const iframe = document.getElementById("renderFrame");

        if (!urlInput) {
            resultBox.innerHTML = `<p class="text-red-600 font-bold">Please enter a URL.</p>`;
            return;
        }

        rawColumn.textContent = "Fetching raw HTML…";
        resultBox.innerHTML = `<p class="text-blue-600 font-bold">Analysing…</p>`;

        // Show live preview visually
        iframe.src = urlInput;

        let rawHtml = "";

        // --- FETCH RAW HTML FROM VERCEL SERVERLESS FUNCTION ---
        try {
            const apiUrl = `/api/fetch-html.js?url=${encodeURIComponent(urlInput)}`;
            console.log("Fetching:", apiUrl);

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("API returned " + response.status);

            const data = await response.json();
            rawHtml = data.html || "";

            rawColumn.textContent = rawHtml.substring(0, 20000) || "No HTML returned.";

            console.log("RAW HTML LENGTH:", rawHtml.length);

            if (!rawHtml || rawHtml.length < 50) {
                resultBox.innerHTML = `
                    <p class="text-red-600 font-bold text-xl">Raw HTML is empty or blocked.</p>
                    <p class="text-gray-700">The website may block server-side requests.</p>
                `;
                return;
            }

        } catch (err) {
            console.error(err);
            rawColumn.textContent = "Error fetching raw HTML.";
            resultBox.innerHTML = `
                <p class="text-red-600 font-bold">Error fetching raw HTML</p>
                <p class="text-gray-700">${err.message}</p>
            `;
            return;
        }

        // --- DETECT SSR OR CSR ---
        const isCSR =
            rawHtml.includes("BAILOUT_TO_CLIENT_SIDE_RENDERING") ||
            rawHtml.includes("__next_f.push") ||
            (rawHtml.includes('id="__next"') && !rawHtml.match(/<main|<div|<section/i));

        if (isCSR) {
            resultBox.innerHTML = `
                <p class="text-yellow-700 font-bold text-xl">Client-Side Rendering (CSR)</p>
                <p class="mt-2 text-gray-700">
                    This HTML was mostly empty and depends on JavaScript to render content.
                </p>
            `;
        } else {
            resultBox.innerHTML = `
                <p class="text-green-700 font-bold text-xl">Server-Side Rendering (SSR)</p>
                <p class="mt-2 text-gray-700">
                    Meaningful content was returned directly in the HTML.
                </p>
            `;
        }
    }
    </script>

    <!-- ENSURE BUTTON ALWAYS WORKS -->
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("checkBtn");

        if (!btn) {
            console.error("Analyse button not found in DOM!");
            return;
        }

        console.log("Button event attached.");
        btn.addEventListener("click", runCheck);
    });
    </script>

</body>
</html>
